{% extends "article/base_content.html" %}
{% load emarkdown %}
{% load captureas %}
{% load date %}
{% load profile %}
{% load crispy_forms_tags %}
{% load set %}
{% load thumbnail %}
{% load i18n %}
{% load interventions %}

{% block title %}
    {{ article_version.title }}
{% endblock %}



{% block meta_image %}{% spaceless %}
    {% if article_version.image %}
        {{ article_version.image.article_illu.url }}
    {% else %}
        {{ block.super }}
    {% endif %}
{% endspaceless %}{% endblock %}



{% block opengraph %}
    <meta property="og:type" content="article">

    {% if article_version.pubdate %}
        <meta property="og:article:published_time" content="{{ article_version.pubdate|date:"c" }}">
    {% endif %}

    <meta property="og:article:section" content="Articles">
    {% for tag in tags.all %}
        <meta property="og:article:tag" content="{{ tag.title }}">
    {% endfor %}
{% endblock %}



{% block breadcrumb %}
    <li>{{ article_version.title }}</li>
{% endblock %}



{% block article_schema %}
    itemscope itemtype="http://schema.org/Article"
{% endblock %}



{% block headline %}
    {% if article_version.licence %}
        <span class="license" itemprop="license">
            {{ article_version.licence }}
        </span>
    {% endif %}

    <h1 {% if article_version.image %}class="illu"{% endif %} itemprop="name">
        {% if article_version.image %}
            <img src="{{ article_version.image.article_illu.url }}" alt="" itemprop="thumbnailUrl">
        {% endif %}
        {{ article_version.title }}
    </h1>

    {% if article_version.description %}
        <h2 class="subtitle">
            {{ article_version.description }}
        </h2>
    {% endif %}

    <ul class="taglist" itemprop="keywords">
        {% for tag in tags.all %}
            <li>
                <a href="{% url "zds.article.views.index" %}?tag={{ tag.slug }}">
                    {{ tag.title }}
                </a>
            </li>
        {% endfor %}
    </ul>

    <span class="pubdate">
        {% trans "Publié " %}
        <time datetime="{{ article_version.pubdate|date:"c" }}" pubdate="pubdate" itemprop="datePublished">
            {{ article_version.pubdate|format_date }}
        </time>
    </span>

    {% include "misc/zen_button.part.html" %}

    <div class="authors">
        <span class="authors-label">{% trans "Contributeur" %}{{ authors.all|pluralize }} : </span>
        <ul>
            {% for member in authors.all %}
                <li>
                    {% include "misc/member_item.part.html" with avatar=True author=True %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}



{% block article_content_schema %}
    itemprop="articleBody"
{% endblock %}



{% block content %}
    {{ article_version.txt|safe }}

    {% include "article/includes/pager.part.html" %}

    {% include "article/includes/warn_typo.part.html" with article=article_version authors=authors%}

{% endblock %}



{% block content_after %}
    <h3 class="comments-title" id="reactions">
        {% if article_version.get_reaction_count > 0 %}
            <span itemprop="commentCount">
                {{ article_version.get_reaction_count }}
            </span>
            {% trans "réaction" %}{{ article_version.get_reaction_count|pluralize }}
        {% else %}
            {% trans "Aucune réaction" %}
        {% endif %}
    </h3>


    {% include "misc/pagination.part.html" with position="top" topic=article_version is_online=True anchor="reactions" %}


    {% for message in reactions %}
        {% captureas form_action %}
            {% url "zds.article.views.answer" %}?article={{ article_version.pk }}
        {% endcaptureas %}

        {% captureas edit_link %}
            {% url "zds.article.views.edit_reaction" %}?message={{ message.pk }}
        {% endcaptureas %}

        {% captureas cite_link %}
            {% url "zds.article.views.answer" %}?article={{ article_version.pk }}&amp;cite={{ message.pk }}
        {% endcaptureas %}

        {% captureas upvote_link %}
            {% url "zds.article.views.like_reaction" %}?message={{ message.pk }}
        {% endcaptureas %}

        {% captureas downvote_link %}
            {% url "zds.article.views.dislike_reaction" %}?message={{ message.pk }}
        {% endcaptureas %}

        {% captureas alert_solve_link %}
            {% url "zds.article.views.solve_alert" %}
        {% endcaptureas %}

        {% if forloop.first and nb > 1 %}
            {% set True as is_repeated_message %}
        {% else %}
            {% set False as is_repeated_message %}
        {% endif %}


        {% include "misc/message.part.html" with perms_change=perms.article.change_reaction topic=article_version comment_schema=True %}
    {% endfor %}


    {% include "misc/pagination.part.html" with position="bottom" topic=article_version is_online=True anchor="reactions" %}



    {% captureas form_action %}
        {% url 'zds.article.views.answer' %}?article={{ article_version.pk }}
    {% endcaptureas %}

    {% include "misc/message_form.html" with member=user topic=article_version %}
{% endblock %}



{% block sidebar_actions %}
    {% if perms.article.change_article %}
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Validation">
            <h3>{% trans "Validation" %}</h3>
            <ul>
                <li>
                    <a href="{{ article_version.get_absolute_url }}" class="ico-after offline blue">
                        {% trans "Version hors ligne" %}
                    </a>
                </li>
                <li>
                    <a href="#unpublish" class="open-modal ico-after cross blue">{% trans "Dépublier" %}</a>
                    <form action="{% url "zds.article.views.modify" %}" method="post" class="modal modal-small" id="unpublish">
                        <p>
                            {% blocktrans %}
                                <strong>Attention !</strong> Vous allez dépublier un article actuellement <strong>en ligne</strong>.
                            {% endblocktrans %}
                        </p>
                        <button type="submit" name="invalid-article">
                            {% trans "Confirmer" %}
                        </button>
                        <input type="hidden" name="article" value="{{ article_version.pk }}">
                        <input type="hidden" name="version" value="{{ version }}">
                        {% csrf_token %}
                    </form>
                </li>
                <li>
                    <a href="{% url "zds.article.views.history_validation" article_version.pk %}" class="ico-after history blue">
                        {% trans "Historique de validation" %}
                    </a>
                </li>
            </ul>
        </div>
    {% elif user in authors.all %}
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Gestion">
            <h3>{% trans "Gestion" %}</h3>
            <ul>
                <li>
                    <a href="{{ article_version.get_absolute_url }}" class="ico-after offline blue">
                        {% trans "Version hors ligne" %}
                    </a>
                </li>
            </ul>
        </div>
    {% endif %}

    <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Actions">
        <h3>{% trans "Actions" %}</h3>
        <ul>
            <li>
            {% with subscribe_array=article|has_subscribed_answer_topic %}
                <form action="{% url "zds.article.views.modify" %}" method="post">
                    <input type="hidden" name="article" value="{{ article_version.pk }}">
                    <input type="hidden" name="nb" value="{{ nb }}">
                    <input type="hidden" name="page" value="{{ nb }}">
                    <input type="hidden" name="follow" value="{% if subscribe_array.has_subscribed_answer %}-1{% else %}1{% endif %}">
                    {% csrf_token %}

                    <button
                        class="follow ico-after star {% if subscribe_array.has_subscribed_answer %}yellow{% else %}blue{% endif %}"
                        type="submit" data-ajax-input="follow-article"
                        data-content-on-click="
                            {% if subscribe_array.has_subscribed_answer %}
                                {% trans "Suivre cet article" %}
                            {% else %}
                                {% trans "Ne plus suivre cet article" %}
                            {% endif %}
                        "
                    >
                        {% if subscribe_array.has_subscribed_answer %}
                            {% trans "Ne plus suivre cet article" %}
                        {% else %}
                            {% trans "Suivre cet article" %}
                        {% endif %}
                    </button>
                </form>
            {% endwith %}
            </li>
        </ul>
    </div>

    <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Télécharger">
        <h3>{% trans "Télécharger" %}</h3>
        <ul>
            <li>
                <a href="{% url "zds.article.views.download" %}?article={{ article_version.pk }}&online"
                   class="ico-after download blue"
                >
                    {% trans "Archive" %}
                </a>
            </li>
        </ul>
    </div>

    {% include "misc/social_buttons.part.html" with link=article_version.get_absolute_url_online text=article_version.title %}
{% endblock %}
